<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[雨吁]]></title>
  <link href="http://shadow.ma/atom.xml" rel="self"/>
  <link href="http://shadow.ma/"/>
  <updated>2012-10-22T20:01:22+08:00</updated>
  <id>http://shadow.ma/</id>
  <author>
    <name><![CDATA[Shadow Ma,i@shadow.ma]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[使用 NetworkManager 設置 VPNC 和路由表]]></title>
    <link href="http://shadow.ma/blog/2012/10/18/configure-vpnc-route-tables-with-networkmanager/"/>
    <updated>2012-10-18T01:20:00+08:00</updated>
    <id>http://shadow.ma/blog/2012/10/18/configure-vpnc-route-tables-with-networkmanager</id>
    <content type="html"><![CDATA[<p>昨晚看到個 VPN 服務 <a href="http://106.187.44.5/home?referral=70588D95C2F9DF00D908B3CC2282F650" title="IQLink">IQLink</a>，免費用戶每月有 100G 流量，測了下速度還不錯，可以留着以備不時之需。</p>

<p>用 VPN 當然得配置路由表，之前用 PPTP VPN 時就配置過 <a href="http://code.google.com/p/chnroutes/" title="chnroutes">chnroutes</a>，用來給國內 ip 添加路由表，用非 VPN 線路高速訪問國內網站，還能節省流量。</p>

<!-- more -->


<p>IQLink 提供的是 Cisco VPN，Linux 下要用 VPNC 連接，chnroutes 網站上提供了 PPTP 和 OpenVPN 的設置教程，唯獨沒有 VPNC，還好 VPNC 支持連接腳本，默認配置的 <code>/etc/vpnc/vpnc-script</code> 能在執行 <code>pre-init</code>、<code>connect</code>、<code>post-connect</code>、<code>disconnect</code>、<code>post-disconnect</code> 和 <code>reconnect</code> 六種 action 時調用自定義腳本，只要把 <code>python chnroutes.py -p linux</code> 生成的腳本 <code>ip-pre-up</code> 和 <code>ip-down</code> 分別放入 <code>/etc/vpnc/pre-init.d</code> 和 <code>/etc/vpnc/post-disconnect.d</code> 就能在連接 VPN 前後成功添加恢復路由表，但在使用 NetworkManager 連接 VPNC 時，發現這些腳本根本就沒有被執行，NM 的 VPNC 插件用自帶的 <code>nm-vpnc-service-vpnc-helper</code> 替代了 <code>vpnc-script</code>，完全不讀取 <code>/etc/vpnc</code> 下的配置，而且這東西是二進制文件沒法改，試過直接替換成 <code>vpnc-script</code> 也不行，正準備放棄時突然想起 NetworkManager 也支持連接腳本，直接用 NetworkManager 配置的話就不用再爲每種 VPN 都設定路由表了。</p>

<p>把下面的腳本（根據自己實際情況修改）放入 <code>/etc/NetworkManager/dispatcher.d</code>，腳本中在觸發 <code>vpn-down</code> 恢復路由表的操作中我排除了正在配置的 VPNC 連接的 UUID，因爲斷開連接時路由表已經被恢復，導致腳本返回一大串錯誤，這應該是 <code>nm-vpnc-service-vpnc-helper</code> 中有對路由表的操作的原因。</p>

<figure class='code'><figcaption><span>99-chnroutes</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nv">INTERFACE</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">STATUS</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="s2">&quot;$STATUS&quot;</span> in
</span><span class='line'>        <span class="s1">&#39;vpn-up&#39;</span><span class="o">)</span>
</span><span class='line'>                <span class="nb">exec</span> /etc/chnroutes/vpnup <span class="c">#chnroutes 生成的 ip-pre-up</span>
</span><span class='line'>                ;;
</span><span class='line'>        <span class="s1">&#39;vpn-down&#39;</span><span class="o">)</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$CONNECTION_UUID&quot;</span> !<span class="o">=</span> <span class="s2">&quot;1f2c647b-dd70-4f97-8300-0cf6cd4a2e4c&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">                </span><span class="nb">exec</span> /etc/chnroutes/vpndown <span class="c">#chnroutes 生成的 ip-down</span>
</span><span class='line'>                <span class="k">fi</span>
</span><span class='line'>                ;;
</span><span class='line'><span class="k">esac</span>
</span></code></pre></td></tr></table></div></figure>


<p>到此處還不能正常使用，chnroutes 生成的腳本是給 PPTP 用的，默認是要在 PPP 撥號前執行，在 VPN 鏈接前路由表就設置好了，而 NetworkManager 連接腳本中的 <code>vpn-up</code> 要在連接建立後才會被觸發，像我正在配置的 VPNC 因爲之前提到的 <code>nm-vpnc-service-vpnc-helper</code> 中有對路由表的操作，再次設置會提示出錯，其它類型的 VPN 路由表會被成讓所有國內 ip 都走 VPN，解決方法是把 chnroutes 生成的設置腳本 <code>ip-pre-up</code>（上面腳本中的 <code>vpnup</code>）中的：</p>

<pre><code>OLDGW=`ip route show | grep '^default' | sed -e 's/default via \([^ ]*\).*/\1/'`
</code></pre>

<p>修改爲：</p>

<pre><code>OLDGW=`ip route show | grep '^[^d].*proto static'|sed -e 's/.*via \([^ ]*\).*/\1/'`
</code></pre>

<p>重新連接，測試成功。現在用 NetworkManager 連接的 VPN 都會自動設置路由表，以前給 PPTP 設置的撥號腳本可以移除了。</p>

<p>其實沒必要像我一樣把 <code>ip-pre-up</code> 和 <code>ip-down</code> 改成 <code>vpnup</code> 和 <code>vpndown</code>，只是這裏 <code>vpnup</code> 已經不是 pre-up 了，看着不爽而已。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[切換到了 systemd]]></title>
    <link href="http://shadow.ma/blog/2012/10/06/switched-arch-to-systemd/"/>
    <updated>2012-10-06T19:35:00+08:00</updated>
    <id>http://shadow.ma/blog/2012/10/06/switched-arch-to-systemd</id>
    <content type="html"><![CDATA[<p>Arch Linux 的啓動系統正在向 systemd 遷移，現在差不多所有的系統配置都從 <code>/etc/rc.conf</code> 中遷出，完全切換到 systemd 已經沒什麼困難，詳細過程就不說了，<a href="https://wiki.archlinux.org/index.php/Systemd" title="systemd">wiki</a> 寫的非常詳細，這方面文章也一大把。</p>

<!-- more -->


<p>照着 wiki 來，選擇了純 systemd 安裝，完全替代了 sysvinit 和 initscripts，因爲 systemd 有自帶 journal 所以幹掉了 syslog-ng，服務配置完後還啓用了 readahead。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ systemd-analyze 
</span><span class='line'>Startup finished in 3608ms (kernel) + 3562ms (userspace) = 7170ms</span></code></pre></td></tr></table></div></figure>


<p>效果顯著，fbsplash 一閃而過，進度都沒走完 KDM 就出來了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[買了 Hellohost 的 VPS]]></title>
    <link href="http://shadow.ma/blog/2012/10/02/bought-hellohost-vps/"/>
    <updated>2012-10-02T14:48:00+08:00</updated>
    <id>http://shadow.ma/blog/2012/10/02/bought-hellohost-vps</id>
    <content type="html"><![CDATA[<p>快用了一年 Hellohost 的主機，這個月就要到期，轉到 Octopress 後，這 PHP 主機就沒必要再續費了，現在 Blog 放 GitHub 上最大的缺點就是隻支持綁定一個域名，以前 RSS 定閱的子域名必須用其它主機反向代理或重定向，還有很多鏈接也要重定向，而且只要不直接在 GitHub 上綁定域名的話，就可以直接使用 Page 的鏈接訪問，正好可以讓牆內的朋友用這個。</p>

<!-- more -->


<p>之前幫朋友弄了個阿里雲主機，就試着把域名先解析到這主機上，解析成功後這被封的域名竟然能在牆內訪問不再被重置了，當時着實讓我興奮了一把，以爲這麼簡單就解封了，但之後用 Cloudflare 的 CDN 確顯示「 Website unreachable」，掛着 VPN 試了一下發現被重置，才明白根本就沒解封，牆是雙向的，把被封的域名解析到國內 ip 是能讓牆內正常訪問，但反過來會封鎖牆外的訪問，得不償失，看來還得弄個牆外的主機。</p>

<p>虛擬主機不太適合了，VPS 也只需要低階的就行，看 Hellohost 有賣就先買了一個月試試，用了她這一年的虛擬主機還算穩定，只買了個 64M 的，其實若是不再搞其它東西的話，只是純靜態的 Octopress 放上來也是夠的 ，但爲了方便管理還是放 GitHub 上吧。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># free -m
</span><span class='line'>             total       used       free     shared    buffers     cached
</span><span class='line'>Mem:            64         10         53          0          0          0
</span><span class='line'>-/+ buffers/cache:         10         53
</span><span class='line'>Swap:            0          0          0</span></code></pre></td></tr></table></div></figure>


<p>用的 Nginx，只拿來作重定向和反向代理的確是有點浪費。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Hello Octopress!]]></title>
    <link href="http://shadow.ma/blog/2012/09/26/hello-octopress/"/>
    <updated>2012-09-26T17:16:00+08:00</updated>
    <id>http://shadow.ma/blog/2012/09/26/hello-octopress</id>
    <content type="html"><![CDATA[<p>近幾個月一真沒更新過博客，也沒登錄過，上一次登錄還是因爲升級 Wordpress ，懶得再折騰 Wordpress 了，最近收到了主機的續費通知就想換個平臺，很久以前就想試試 Octopress，在主機到期前正好嘗試下。</p>

<!-- more -->


<p>花兩天改造了下模板，佈局弄得和以前一樣了，之前的文章因爲以前的爛習慣鏈接格式亂七八糟的，全部處理太麻煩所以不想轉過來了，先用段時間看吧。</p>
]]></content>
  </entry>
  
</feed>
